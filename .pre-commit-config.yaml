# See https://pre-commit.com for more information
# See https://pre-commit.com/hooks.html for more hooks
repos:
  # Generic hooks
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: trailing-whitespace
        exclude: '(^mirrormanager2/static/fedora/|^mirrormanager2/templates/fedora/)'
      - id: end-of-file-fixer
        exclude: '(^mirrormanager2/static/fedora/|^mirrormanager2/templates/fedora/)'
      - id: check-yaml
      - id: check-added-large-files

  # # License headers
  # - repo: https://github.com/fsfe/reuse-tool
  #   rev: v2.1.0
  #   hooks:
  #     - id: reuse

  # Formatting
  - repo: https://github.com/psf/black
    rev: 26.1.0
    hooks:
      - id: black

  # Ruff
  - repo: https://github.com/charliermarsh/ruff-pre-commit
    # Ruff version.
    rev: v0.14.14
    hooks:
      - id: ruff

  - repo: local
    hooks:
      - id: database-graph
        name: Update the database schema graph
        language: python
        additional_dependencies: [paracelsus, sqlalchemy-helpers, flask]
        entry: paracelsus
        args: [inject, doc/database_schema.md, "mirrormanager2.lib.model:BASE"]
        files: mirrormanager2/lib/model\.py
        require_serial: true
        pass_filenames: false
        verbose: true
      - id: check-jinja2-templates
        name: Check Jinja2 template syntax
        # Validates Jinja2 templates by compiling them with the correct loader
        # configuration. Templates use relative imports like {% extends "master.html" %}
        # which need to resolve from the theme directory (rocky/), not the parent
        # templates/ directory. This catches syntax errors like malformed comment
        # tags before commit. Only validates Rocky templates since Fedora templates
        # are kept for reference only.
        language: python
        additional_dependencies: [jinja2]
        entry: python
        args:
          - -c
          - |
            from jinja2 import Environment, FileSystemLoader
            import sys
            env = Environment(loader=FileSystemLoader('mirrormanager2/templates/rocky'))
            [env.get_template(f.replace('mirrormanager2/templates/rocky/', '')) for f in sys.argv[1:]]
        files: ^mirrormanager2/templates/rocky/.*\.html$
        pass_filenames: true
