# MirrorManager2 Deployment Guide

This document covers deployment considerations and requirements.

## Architecture Overview

### Production Deployment (Fedora Infrastructure)

Based on [Fedora Infra SOP](https://docs.fedoraproject.org/en-US/infra/sysadmin_guide/mirrormanager/):

```
┌─────────────────────────────────────────────────────────────────┐
│                        OpenShift Cluster                         │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  MirrorManager Frontend Deployment                       │   │
│  │  - Flask web application                                 │   │
│  │  - Handles user/admin UI                                 │   │
│  │  - report_mirror checkins                                │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                   │
│                              │                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  CronJobs                                                │   │
│  │  - mm2_update-master-directory-list (UMDL)              │   │
│  │  - mm2_crawler (multiple instances with --fraction)      │   │
│  │  - mm2_get-netblocks                                     │   │
│  │  - generate-mirrorlist-cache                             │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                   │
│                              ▼                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  PostgreSQL Database                                     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                   │
└──────────────────────────────┼───────────────────────────────────┘
                               │
                               │ NFS mount (/srv)
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Master Mirror Storage                         │
│                    (content being mirrored)                      │
└─────────────────────────────────────────────────────────────────┘

                               │
                               │ pickle file sync
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                        Proxy Servers                             │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  mirrorlist1 container                                   │   │
│  │  mirrorlist2 container                                   │   │
│  │  (mirrorlist-server from separate repo)                  │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                               │
                               │ serves /mirrorlist and /metalink
                               ▼
                          End Users
```

---

## Components to Deploy

### 1. Web Application (Frontend)

**Required for:** User interface, admin interface, report_mirror, API

**Dependencies:**
- Python 3.10+
- PostgreSQL (production) or SQLite (development)
- OIDC provider (Fedora Accounts) or local auth
- SMTP server (for error notifications)

**Deployment:**
```bash
# Install with production dependencies
poetry install --extras deploy

# Run with gunicorn
gunicorn -w 4 -b 0.0.0.0:8080 "mirrormanager2.app:create_app()"
```

**Environment Variables:**
- `MM2_CONFIG` - Path to configuration file

### 2. Database

**Options:**
- PostgreSQL (recommended for production)
- SQLite (development only)

**Setup:**
```bash
# Initialize/migrate database
poetry run flask -A mirrormanager2.app db sync
```

### 3. Backend Jobs (Cron)

**Required jobs:**

| Job | Schedule | Purpose |
|-----|----------|---------|
| UMDL | Every 5 min | Scan master mirror |
| Crawler | Multiple daily | Check mirror freshness |
| Propagation | Hourly | Check repomd.xml freshness |
| Netblocks | Weekly | Update BGP data |
| Expire stats | Daily | Clean old statistics |
| Generate cache | Hourly | Create mirrorlist pickle |

### 4. MirrorList Server (SEPARATE DEPLOYMENT)

**Repository:** https://github.com/adrianreber/mirrorlist-server

This is NOT part of this codebase. It:
- Loads pickle file generated by backend
- Serves `/mirrorlist` and `/metalink` endpoints
- Runs on proxy servers as containers

---

## Configuration Reference

### Sample Configuration File

```python
# /etc/mirrormanager/mirrormanager2.cfg

# Database
SQLALCHEMY_DATABASE_URI = "postgresql://user:pass@host:5432/mirrormanager"

# Security
SECRET_KEY = "your-very-secret-key-here"
PASSWORD_SEED = "another-secret-seed"

# Authentication
MM_AUTHENTICATION = "fas"  # or "local"
OIDC_CLIENT_SECRETS = "/etc/mirrormanager/client_secrets.json"

# Admin groups (for FAS auth)
ADMIN_GROUP = ["sysadmin-main", "sysadmin-web"]

# Email
ADMIN_EMAIL = "admin@example.com"
EMAIL_FROM = "mirrormanager@example.com"
SMTP_SERVER = "smtp.example.com"

# Cookies
MM_COOKIE_REQUIRES_HTTPS = True
MM_COOKIE_NAME = "MirrorManager"

# Logging
MM_LOG_DIR = "/var/log/mirrormanager"

# Master Mirror
UMDL_PREFIX = ""
UMDL_MASTER_DIRECTORIES = [
    {
        "category": "Fedora Linux",
        "path": "/srv/pub/fedora/linux",
    },
    # ... more categories
]

# Crawler
CRAWLER_RSYNC_PARAMETERS = "--no-motd --timeout 14400"
CRAWLER_AUTO_DISABLE = 4

# GeoIP
GEOIP_BASE = "/usr/share/GeoIP"

# Countries
EMBARGOED_COUNTRIES = ["CU", "IR", "KP", "SD", "SY"]

# Statistics
ACCESS_STATS_KEEP_DAYS = 30
PROPAGATION_KEEP_DAYS = 7

# File aging
MAX_STALE_DAYS = 4

# External services
BODHI_URL = "https://bodhi.fedoraproject.org"
USE_FEDORA_MESSAGING = True

# UI options
SHOW_MAPS = True
SHOW_PROPAGATION = True
STATIC_MAP = "map.png"
INTERACTIVE_MAP = "mirrors.html"
```

---

## Development Setup

### Prerequisites
```bash
# Install dependencies
sudo dnf install poetry tox ansible vagrant vagrant-libvirt vagrant-sshfs

# Clone repository
git clone https://github.com/fedora-infra/mirrormanager2
cd mirrormanager2
```

### Option 1: Using Vagrant (Recommended)
```bash
# Start development VM
vagrant up

# SSH into VM and start server
vagrant ssh -c "sudo systemctl restart mirrormanager2"

# Access at https://mirrormanager2.tinystage.test/
```

### Option 2: Manual Setup with Poetry
```bash
# Install dependencies
poetry install

# Set up tiny-stage for OIDC (see README.rst)
# ... tiny-stage setup ...

# Add certificate
curl -k https://ipsilon.tinystage.test/ca.crt >> $(poetry run python -m certifi)

# Register OIDC client
poetry run oidc-register https://ipsilon.tinystage.test/idp/openidc/ http://localhost:5000/authorize

# Initialize database
poetry run flask -A mirrormanager2.app db sync

# Populate with test data
poetry run python devel/populate.py

# Start development server
poetry run ./runserver.py
```

### Option 3: With local auth (no OIDC)
```python
# In your config file:
MM_AUTHENTICATION = "local"
```

---

## Production Checklist

### Security
- [ ] Generate unique `SECRET_KEY`
- [ ] Generate unique `PASSWORD_SEED`
- [ ] Enable HTTPS (`MM_COOKIE_REQUIRES_HTTPS = True`)
- [ ] Configure OIDC properly
- [ ] Set appropriate `ADMIN_GROUP`
- [ ] Configure embargoed countries

### Database
- [ ] Use PostgreSQL
- [ ] Set up backups
- [ ] Run migrations (`flask db sync`)
- [ ] Configure connection pooling

### Monitoring
- [ ] Health checks at `/healthz/live` and `/healthz/ready`
- [ ] Log aggregation from `MM_LOG_DIR`
- [ ] Error email alerts working
- [ ] Cron job monitoring

### Cron Jobs
- [ ] UMDL configured with correct paths
- [ ] Crawler running with appropriate fractions
- [ ] Netblock updates scheduled
- [ ] Statistics expiration running
- [ ] Mirrorlist cache generation working

### MirrorList Server
- [ ] Pickle file generation working
- [ ] File sync to proxies working
- [ ] Containers restarting properly
- [ ] Failover between containers working

---

## Kubernetes/OpenShift Deployment

### Frontend Deployment
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mirrormanager2-frontend
spec:
  replicas: 2
  template:
    spec:
      containers:
      - name: web
        image: mirrormanager2:latest
        command: ["gunicorn", "-w", "4", "-b", "0.0.0.0:8080", "mirrormanager2.app:create_app()"]
        env:
        - name: MM2_CONFIG
          value: /etc/mirrormanager/mirrormanager2.cfg
        ports:
        - containerPort: 8080
        livenessProbe:
          httpGet:
            path: /healthz/live
            port: 8080
        readinessProbe:
          httpGet:
            path: /healthz/ready
            port: 8080
        volumeMounts:
        - name: config
          mountPath: /etc/mirrormanager
      volumes:
      - name: config
        configMap:
          name: mirrormanager2-config
```

### CronJob Example (UMDL)
```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: umdl
spec:
  schedule: "*/5 * * * *"
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: umdl
            image: mirrormanager2:latest
            command: ["mm2_update-master-directory-list", "--config", "/etc/mirrormanager/mirrormanager2.cfg"]
            volumeMounts:
            - name: master-mirror
              mountPath: /srv
              readOnly: true
          volumes:
          - name: master-mirror
            nfs:
              server: nfs.example.com
              path: /exports/mirror
          restartPolicy: OnFailure
```

---

## Troubleshooting

### Common Issues

**Database connection errors:**
- Check `SQLALCHEMY_DATABASE_URI`
- Verify database is running
- Check network connectivity

**Authentication failures:**
- Verify OIDC client secrets
- Check callback URLs
- Verify tiny-stage/FAS is accessible

**Crawler failures:**
- Check `MM_LOG_DIR/<host_id>.log`
- Verify network access to mirrors
- Check for timeout issues

**UMDL not updating:**
- Verify NFS mount is accessible
- Check `UMDL_MASTER_DIRECTORIES` paths
- Look for permission issues

### Logs

- Web app: stderr (journalctl if systemd)
- Crawler: `MM_LOG_DIR/crawler/<host_id>.log`
- UMDL: stderr
- MirrorList: `/var/log/mirrormanager/mirrorlist{1|2}/` on proxies
