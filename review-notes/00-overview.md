# MirrorManager2 Codebase Overview

**Date:** January 21, 2026  
**Repository:** https://github.com/fedora-infra/mirrormanager2  
**Production URL:** https://mirrormanager.fedoraproject.org/  
**Fedora Infra SOP:** https://docs.fedoraproject.org/en-US/infra/sysadmin_guide/mirrormanager/

## What is MirrorManager2?

MirrorManager2 is the application that manages nearly 400 public mirrors and over 300 private mirrors that carry Fedora, EPEL, and RHEL content. It automatically selects the "best" mirror for a given user based on a set of heuristics including:

- GeoIP information (same country, same continent)
- Network proximity (netblocks, ASN)
- Mirror freshness (up-to-date status)

## High-Level Architecture

The system is divided into **four main parts** as documented in [doc/structure.rst](../doc/structure.rst#L1-L30):

```
+--------------------------+                +--------------+
|                          |                |              |
|  MirrorManager frontend  |                |  MirrorList  |
|                          |                |              |
+-----------+--------------+                +------+-------+
            |                                      ^
            |                                      |
            |                                      |pickle
            |                 +-----------+        |
            |                 |           |        |
            |                 |  Backend  +--------+
            |                 |           |
            |                 +-----+-----+
            |                       ^
            |                       v
            |                 +-----+------+
            |                 |            |
            +---------------->|  Database  |
                              |            |
                              +------------+
```

### 1. Database (PostgreSQL/SQLite)
Stores all mirror, site, host, directory, and file information.

### 2. Frontend (Flask Web Application)
- User interface for mirror administrators
- Admin interface for MM administrators  
- Provides mirror listing pages

### 3. Backend (Multiple CLI utilities/cron jobs)
- `mm2_update-master-directory-list` (UMDL) - scans master mirror content
- `mm2_crawler` - crawls mirrors to check freshness
- Various other utilities for maintenance

### 4. MirrorList Server (SEPARATE REPOSITORY)
- **Not in this codebase!**
- Lives at: https://github.com/adrianreber/mirrorlist-server
- Lightweight WSGI app that serves `/mirrorlist` and `/metalink` endpoints
- Loads mirror data from a pickle file generated by the backend

## Key Files & Entry Points

| Component | File | Description |
|-----------|------|-------------|
| Web App Factory | [mirrormanager2/app.py](../mirrormanager2/app.py#L49-L134) | Flask application factory |
| Development Server | [runserver.py](../runserver.py#L1-L48) | Local dev server runner |
| Default Config | [mirrormanager2/default_config.py](../mirrormanager2/default_config.py#L1-L203) | All configuration options |
| Database Models | [mirrormanager2/lib/model.py](../mirrormanager2/lib/model.py#L1-L1100) | SQLAlchemy ORM models |
| Library Functions | [mirrormanager2/lib/__init__.py](../mirrormanager2/lib/__init__.py#L1-L1134) | Core library functions |
| Web Views | [mirrormanager2/views.py](../mirrormanager2/views.py#L1-L1339) | User-facing routes |
| Admin UI | [mirrormanager2/admin.py](../mirrormanager2/admin.py#L1-L100) | Flask-Admin views |
| REST API | [mirrormanager2/api.py](../mirrormanager2/api.py#L1-L154) | API endpoints |
| XML-RPC | [mirrormanager2/xml_rpc.py](../mirrormanager2/xml_rpc.py#L1-L60) | XML-RPC for report_mirror |

## CLI Commands (defined in pyproject.toml)

See [pyproject.toml](../pyproject.toml#L64-L79) for all CLI entry points:

```toml
[tool.poetry.scripts]
report_mirror = { reference = "client/report_mirror", type = "file" }
mm2_crawler = "mirrormanager2.crawler.cli:main"
mm2_emergency-expire-repo = "mirrormanager2.utility.emergency_expire_repo:main"
mm2_generate-worldmap = "mirrormanager2.utility.generate_worldmap:main"
mm2_get-netblocks = "mirrormanager2.utility.netblocks:main"
mm2_move-devel-to-release = "mirrormanager2.utility.move_devel_to_release:main"
mm2_move-to-archive = "mirrormanager2.utility.move_to_archive:main"
mm2_update-EC2-netblocks = "mirrormanager2.utility.update_ec2_netblocks:main"
mm2_update-master-directory-list = "mirrormanager2.utility.update_master_directory_list:main"
mm2_create_install_repo = "mirrormanager2.utility.create_install_repo:main"
mm2_upgrade-install-repo = "mirrormanager2.utility.upgrade_install_repo:main"
mm2_last-sync = "mirrormanager2.utility.last_sync:main"
mm2_expire-stats = "mirrormanager2.utility.expire_statistics:main"
mm2_mirrorlist-statistics = "mirrormanager2.utility.mirrorlist_statistics:main"
mm2_add-product = "mirrormanager2.utility.add_product:main"
```

## Technology Stack

- **Python 3.10+** (see [pyproject.toml](../pyproject.toml#L28))
- **Flask 2.2/3.x** - Web framework
- **SQLAlchemy** - ORM
- **Flask-Admin** - Admin interface
- **Flask-OIDC** - Authentication (Fedora Accounts)
- **Fedora Messaging** - AMQP notifications
- **GeoIP2** - Geographic location lookups
- **Click** - CLI framework
- **Rich** - Terminal UI (progress bars, logging)

## Related Documentation

- [01-components.md](01-components.md) - Detailed component breakdown
- [02-database-models.md](02-database-models.md) - Database schema details
- [03-backend-utilities.md](03-backend-utilities.md) - Backend scripts
- [04-web-application.md](04-web-application.md) - Web app details
- [05-crawler.md](05-crawler.md) - Crawler deep dive
- [06-deployment.md](06-deployment.md) - Deployment considerations
- [07-configuration.md](07-configuration.md) - Configuration reference
